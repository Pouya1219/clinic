<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>سیستم وقت‌دهی پزشکی</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
:root {
    --appointment-primary: #2196F3;
    --appointment-secondary: #607D8B;
    --appointment-success: #4CAF50;
    --appointment-danger: #F44336;
    --appointment-warning: #FFC107;
    --appointment-info: #00BCD4;
    --appointment-light: #ECEFF1;
    --appointment-dark: #263238;
    --appointment-gray: #90A4AE;
    --appointment-border: #CFD8DC;
    --appointment-hover: #E3F2FD;
    --appointment-unavailable:rgb(211, 82, 102);
    --appointment-current: #E8F5E9;
    --appointment-navbar: #94e0f3;
    --appointment-primary: #2196F3;
    --appointment-secondary: #607D8B;
    --appointment-success: #4CAF50;
    --appointment-danger: #F44336;
    --appointment-warning: #FFC107;
    --appointment-info: #00BCD4;
    --appointment-light: #ECEFF1;
    --appointment-dark: #263238;
    --appointment-gray: #90A4AE;
    --appointment-border: #CFD8DC;
    --appointment-hover: #E3F2FD;
    --appointment-unavailable:rgb(244, 84, 108);
    --appointment-current:rgb(44, 120, 50);
}
body {
    background-color: #F5F5F5;
    color: var(--appointment-dark);
    line-height: 1.6;
}
.appointment_date-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.appointment_current-range {
    font-size: 18px;
    font-weight: bold;
    color: var(--appointment-primary);
}
.appointment_today-date {
    font-size: 14px;
    color: var(--appointment-secondary);
}
.appointment_navigation {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-right: auto;
    min-width: 300px; /* برای جلوگیری از پرش المان‌ها */
}

{% comment %} .appointment_time-slot.current-time {
    background-color: var(--appointment-current) !important;
    border: 2px solid var(--appointment-primary) !important;
    box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
    position: relative;
}

.appointment_time-slot.current-time::after {
    content: 'اکنون';
    position: absolute;
    top: -10px;
    right: 50%;
    transform: translateX(50%);
    background-color: var(--appointment-primary);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    z-index: 1;
} {% endcomment %}
.appointment_nav-button {
    background: var(--appointment-primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}
/* اضافه کردن به استایل‌های موجود */

.appointment_nav-button:hover {
    background: var(--appointment-secondary);
    transform: scale(1.1);
}

.appointment_date-range {
    font-size: 16px;
    font-weight: 500;
    color: var(--appointment-dark);
    min-width: 200px;
    text-align: center;
}

.appointment_time-slot {
    padding: 1px;
    border: 1px solid var(--appointment-border);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    min-height: 60px;
    background-color: white;
    flex-direction: column;
}
.appointment_time-slot:hover {
    background-color: var(--appointment-hover);
    transform: scale(1.02);
    z-index: 1;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}
.appointment_time-slot.unavailable {
    background-color: var(--appointment-unavailable);
    cursor: not-allowed;
    color: var(--appointment-danger);
}

.appointment_time-slot.current {
    background-color: var(--appointment-current);
    border: 2px solid var(--appointment-success);
}

/* استایل برای نمایش شیفت‌های کاری */
.appointment_time-slot.shift-1 {
    border-left: 3px solid var(--appointment-success);
}

.appointment_time-slot.shift-2 {
    border-left: 3px solid var(--appointment-info);
}
.appointment_time-slot[data-appointment-id] {
    position: relative;
    overflow: hidden;
    cursor: pointer;
}



.appointment_time-slot[data-appointment-id]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px;
    font-size: 12px;
    white-space: pre-line;
}

.current-day {
    background-color: var(--appointment-current);
    font-weight: bold;
}

/* استایل برای روز جاری */
.appointment_header-cell.current-day {
    position: relative;
    background-color: var(--appointment-current);
}

.appointment_header-cell.current-day::after {
    content: '•';
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    color: #48b350
};



/* کانتینر اصلی */
.appointment_container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
}

/* نوار ابزار */
.appointment_navbar {
    background: var(--appointment-navbar);
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.appointment_navbar-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* دکمه‌ها */
.appointment_button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    background-color: var(--appointment-light);
    color: var(--appointment-dark);
}

.appointment_button:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.appointment_button-primary {
    background-color: var(--appointment-primary);
    color: white;
}

.appointment_button-success {
    background-color: var(--appointment-success);
    color: white;
}

.appointment_button-danger {
    background-color: var(--appointment-danger);
    color: white;
}

.appointment_button-info {
    background-color: var(--appointment-info);
    color: white;
}

/* جدول */

.appointment_table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}
.appointment_table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: auto;
    position: relative;
    /*max-height: calc(100vh - 200px);*/ /* ارتفاع با توجه به فاصله از بالای صفحه */
    margin-top: 10px;
}
/* استایل برای scroll bar */
.appointment_table-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.appointment_table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.appointment_table-container::-webkit-scrollbar-thumb {
    background: var(--appointment-secondary);
    border-radius: 4px;
}

.appointment_table-container::-webkit-scrollbar-thumb:hover {
    background: var(--appointment-primary);
}
.appointment_table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 4px;
}







/* مودال */
.appointment_modal {
    margin-top: 250px;
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    animation: appointment_fadeIn 0.3s ease;
}

.appointment_modal-content {
    background: white;
    width: 90%;
    max-width: 800px;
    margin: 50px auto;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    animation: appointment_slideIn 0.3s ease;
}

.appointment_modal-header {
    background-color: cadetblue;
    padding: 10px;
    border-bottom: 1px solid var(--appointment-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.appointment_close-button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--appointment-gray);
}

/* فرم */
.appointment_form {
    padding: 10px;
    margin: 10px;
}

.appointment_form-row {
    display:inline-block ;
    gap: 20px;
    margin-bottom: 15px;
}

.appointment_form-group {
    padding: 10px;
    flex: 1;
}

.appointment_label {
    display: block;
    margin-bottom: 5px;
    color: var(--appointment-dark);
}

.appointment_input,
.appointment_select {
    padding: 8px 12px;
    border: 1px solid var(--appointment-border);
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.appointment_input:focus,
.appointment_select:focus {
    border-color: var(--appointment-primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
}

.appointment_textarea {
    margin: 10px;
    /* width: 100%; */
    min-height: 100px;
    padding: 12px;
    border: 1px solid var(--appointment-border);
    border-radius: 4px;
    resize: auto;
}

.appointment_form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
}

/* دکمه اضطراری */
.appointment_emergency-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 24px;
    background-color: var(--appointment-danger);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.appointment_emergency-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(244, 67, 54, 0.4);
}

/* انیمیشن‌ها */
@keyframes appointment_fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes appointment_slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* رسپانسیو */
@media (max-width: 768px) {
    .appointment_form-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .appointment_navbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .appointment_modal-content {
        width: 95%;
        margin: 20px auto;
    }
}
.appointment_search-container {
    display: flex;
    gap: 10px;
}


.appointment_search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.appointment_search-container .appointment_input {
    flex: 1;
}


.appointment_color-picker {
    width: 1cm;
    height: 1cm;
    padding: 2px;
    border: 1px solid var(--appointment-border);
    border-radius: 50%;
    cursor: pointer;
}

.appointment_color-picker::-webkit-color-swatch-wrapper {
    padding: 0;
}

.appointment_color-picker::-webkit-color-swatch {
    border: none;
    border-radius: 2px;
}

/* برای Firefox */
.appointment_color-picker::-moz-color-swatch {
    border: none;
    border-radius: 2px;
}

/* استایل برای select وضعیت */
.appointment_select option {
    padding: 8px;
}




.appointment_header-cell {
    position:sticky;
    color: white;
    padding: 2px 30px;
    /* font-weight: 500; */
    text-align: center;
    top: 0;
    z-index: 10;
    font-size: xx-small;1;
    white-space: nowrap;
    background-color: var(--appointment-primary);
}


/* برای ردیف دوم هدر */
#dates-header .appointment_header-cell {
     /* ارتفاع ردیف اول + فاصله */
}

/* برای ستون اول (ساعت‌ها) */
.appointment_table td:first-child {
    position: sticky;
    right: 0;
    background-color: var(--appointment-dark);
    z-index: 5;
}


/* سایه برای هدر چسبان */
.appointment_header-cell::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    bottom: -1px;
    height: 2px;
    background: rgba(0, 0, 0, 0.1);
}

.appointment_time-cell {
    position: relative;
    min-width: 80px;
    text-align: center;
    font-weight: bold;
}

.appointment_current_time {
    background-color: rgba(255, 68, 68, 0.1) !important;
}

.appointment_time_wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5px;
}

.appointment_time_indicator {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #ff4444;
    top: 50%;
    transform: translateY(-50%);
}

.appointment_time_wrapper span {
    position: relative;
    z-index: 1;
    background-color: inherit;
    padding: 0 5px;
}

/* انیمیشن برای نشانگر زمان */
@keyframes timeIndicatorPulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

.appointment_time_indicator {
    animation: timeIndicatorPulse 2s infinite;
}


     {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-right: auto;
        min-width: 300px;
    }


    /* اضافه کردن به استایل‌های موجود */



.appointment_has_appointment {
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.appointment_has_appointment:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 2;
}

.appointment_has_appointment::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background-color: var(--appointment-primary);
}
.appointment_has_appointments {
    padding: 5px;
    min-height: 40px;
    height: auto;
}





.appointment_item_content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 5px;
}


.appointment_actions {
    display: flex;
    gap: 3px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.appointment_actions {
    opacity: 1;
}

.appointment_edit_btn,
.appointment_delete_btn {
    padding: 2px 5px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    color: white;
    transition: all 0.3s ease;
}

.appointment_edit_btn {
    background-color: var(--appointment-info);
}

.appointment_delete_btn {
    background-color: var(--appointment-danger);
}

.appointment_edit_btn:hover,
.appointment_delete_btn:hover {
    transform: scale(1.1);
}
.appointment_cell_content {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.appointment_items_container {
    flex: 2;
    display: flex;
    flex-direction: column;
    gap: 2px;
    max-height: 60%; /* نصف ارتفاع سلول */
    overflow-y: auto;
    padding: 3px;
}
.appointment_empty_space {
    flex: 1;
    min-height: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    background: #e1e8ed;
}
.appointment_empty_space:hover {
    background-color: rgba(0,0,0,0.05);
}



.appointment_patient_name {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size : 10px;
}

.appointment_item {
    justify-items:center;
    border-radius: 2px;
    background-color: var(--appointment-light);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}
.appointment_item:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* استایل برای دکمه حذف در مودال */
.appointment_button-danger {
    background-color: var(--appointment-danger);
    color: white;
    margin-left: 10px;
}

.appointment_button-danger:hover {
    background-color: #dc3545;
}

</style>

</head>
<body>
    <div class="appointment_container">
        <!-- نوار اول - تنظیمات زمان ملاقات -->
        <div class="appointment_navbar">
            <div class="appointment_navbar-group">
                <label class="appointment_label">مدت زمان ویزیت:</label>
                <select id="visit_duration" class="appointment_select">
                    <option value="15">15 دقیقه</option>
                    <option value="30" selected>30 دقیقه</option>
                    <option value="45">45 دقیقه</option>
                </select>
            </div>
            <div class="appointment_navbar-group">
                <input type="checkbox" id="visit_edit_previous" class="appointment_checkbox" />
                <label class="appointment_label">امکان ویرایش روزهای قبل</label>
            </div>
            <div class="appointment_navbar-group">
                <input type="checkbox" id="show_patient_info" class="appointment_checkbox" />
                <label class="appointment_label">نمایش اطلاعات بیمار</label>
            </div>
        </div>

        <!-- نوار دوم - اطلاعات پزشک -->
        <div class="appointment_navbar">
            <div class="appointment_navbar-group">
                <select id="visit_doctor" class="appointment_select">
                    <option value="">انتخاب پزشک</option>
                </select>
            </div>
            <div class="appointment_navbar-group">
                <select id="visit_unit" class="appointment_select">
                    <option value="">انتخاب یونیت</option>
                </select>
            </div>
            <!--
            <div class="appointment_navbar-group">
                <input type="text" id="visit_date" class="appointment_input flatpickr" placeholder="تاریخ" />
            </div>
            <button class="appointment_button appointment_button-primary" onclick="filterAppointments()">
                <i class="fas fa-filter"></i> فیلتر
            </button>
        </div>-->

        <!-- نوار سوم - نمایش تقویم -->
       <!-- اضافه کردن دکمه‌های ناوبری به بالای جدول -->
<div class="appointment_navbar">
    <div class="appointment_view-buttons">
        <button class="appointment_button" onclick="showToday()">
            <i class="fas fa-calendar-day"></i> امروز
        </button>
        <button class="appointment_button" onclick="showWeek()">
            <i class="fas fa-calendar-week"></i> هفته
        </button>
        <button class="appointment_button" onclick="showMonth()">
            <i class="fas fa-calendar-alt"></i> ماه
        </button>
        <button class="appointment_button" onclick="showYear()">
            <i class="fas fa-calendar"></i> سال
        </button>
        <button class="appointment_button appointment_button-emergency" onclick="openAppointmentModal(null, null, true)">
    <i class="fas fa-plus"></i> وقت ملاقات اضطراری
</button>
    </div>
    <div class="appointment_navigation">
        <button class="appointment_nav-button" onclick="navigateCalendar('prev')">
            <i class="fas fa-chevron-right"></i>
        </button>
        <span id="current-date-range" class="appointment_date-range"></span>
        <button class="appointment_nav-button" onclick="navigateCalendar('next')">
            <i class="fas fa-chevron-left"></i>
        </button>
    </div>
</div>

        <!-- جدول وقت‌های ملاقات -->
        <div class="appointment_table-container">
            <table class="appointment_table">
                <thead>
                    <tr id="days-header">
                        <th class="appointment_header-cell">ساعت</th>
                    </tr>
                    <tr id="dates-header">
                        <th class="appointment_header-cell"></th>
                    </tr>
                </thead>
                <tbody id="appointment-slots">
                </tbody>
            </table>
        </div>
    </div>

    <!-- مودال رزرو وقت -->
    <div id="appointment-modal" class="appointment_modal">
        <div class="appointment_modal-content">
            <div class="appointment_modal-header">
                <h3>رزرو وقت ملاقات</h3>
                <button class="appointment_close-button" onclick="closeModal()">×</button>
            </div>
            <form id="visit_appointment_form" class="appointment_form">

            <div class="appointment_form-row">
    <div class="appointment_form-group">
        <div class="appointment_search-container">
            <input type="text" id="visit_patient_search" class="appointment_input" placeholder="جستجوی پرونده بیمار..." />
            <button type="button" class="appointment_button appointment_button-primary" onclick="searchPatient()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
</div>
                <div class="appointment_form-row">
                    <div class="appointment_form-group">
                        <label>از ساعت:</label>
                        <input type="text" id="visit_time_from" class="appointment_input time-picker" />
                    </div>
                    <div class="appointment_form-group">
                        <label>تا ساعت:</label>
                        <input type="text" id="visit_time_to" class="appointment_input time-picker" />
                    </div>
                </div>

                <div class="appointment_form-row">
                    <div class="appointment_form-group">
                        <input type="checkbox" id="visit_patient_visited" />
                        <label>بیمار ویزیت شده</label>
                    </div>
                    <div class="appointment_form-group">
                        <input type="checkbox" id="visit_no_file" />
                        <label>پرونده ساخته نشود</label>
                    </div>
                </div>


<div class="appointment_form-row">
    <div class="appointment_form-group">
        <input type="text" id="visit_file_number" class="appointment_input" placeholder="شماره پرونده" readonly />
    </div>
<div class="appointment_form-row">
    <div class="appointment_form-group">
        <input type="text" id="visit_modal_doctor" class="appointment_input" placeholder="نام پزشک" readonly />
    </div>
    <div class="appointment_form-group">
        <input type="text" id="visit_modal_unit" class="appointment_input" placeholder="شماره یونیت" readonly />
    </div>
</div>

                <div class="appointment_form-row">
                    <div class="appointment_form-group">
                        <input type="text" id="visit_firstname" class="appointment_input" placeholder="نام" />
                    </div>
                    <div class="appointment_form-group">
                        <input type="text" id="visit_lastname" class="appointment_input" placeholder="نام خانوادگی" />
                    </div>
                </div>

                <div class="appointment_form-row">
                    <div class="appointment_form-group">
                        <input type="text" id="visit_national_code" class="appointment_input" placeholder="کد ملی" />
                    </div>
                    <div class="appointment_form-group">
                        <input type="tel" id="visit_phone" class="appointment_input" placeholder="شماره تماس" />
                    </div>
                </div>

                <div class="appointment_form-row">
                    <div class="appointment_form-group">
                        <select id="visit_status" class="appointment_select">
                            <option value="">وضعیت</option>
                            <option value="در انتظار">در انتظار</option>
                            <option value="تایید شده">تایید شده</option>
                            <option value="لغو شده">لغو شده</option>
                        </select>
                    </div>
                    <div class="appointment_form-group">
                        <input type="text" id="visit_appointment_date" class="appointment_input flatpickr" placeholder="تاریخ مراجعه" />
                    </div>
                </div>

                <div class="appointment_form-row">
                    <textarea id="visit_description" class="appointment_textarea" placeholder="توضیحات"></textarea>
                </div>
<div class="appointment_form-row">
    <div class="appointment_form-group">
        <label class="appointment_label">رنگ سفارشی:</label>
        <input type="color" id="visit_color_picker" class="appointment_color-picker" value="#ffffff" />
    </div>
</div>
                <div class="appointment_form-actions">
                    <button type="button" class="appointment_button appointment_button-success" onclick="saveAppointment()">
                        <i class="fas fa-save"></i> ثبت نوبت
                    </button>
                    <button type="button" class="appointment_button appointment_button-danger delete-hidden" id="deleteAppointmentBtn" onclick="deleteAppointment()">
                        <i class="fas fa-trash"></i> حذف نوبت
                    </button>
                    <button type="button" class="appointment_button appointment_button-info" onclick="sendSMS()">
                        <i class="fas fa-sms"></i> ارسال پیامک
                    </button>
                    <button type="button" class="appointment_button appointment_button-danger" onclick="closeModal()">
                        <i class="fas fa-times"></i> انصراف
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>

        // متغیرهای سراسری
let currentView = 'week';
let selectedTimeSlot = null;
let appointmentDuration = 30;
let currentDoctor = null;
let showPatientInfo = false;
        // اضافه کردن به initialize
function initialize() {
    setupStatusSelect();
    loadDoctorAndUnitData();
    setupEventListeners();
    setupCalendar();
    updateDateRange();
    currentDate = new Date(); // تنظیم تاریخ اولیه
    currentView = 'week'; // تنظیم نمای پیش‌فرض
    updateDateRange(); // فراخوانی مستقیم برای نمایش تاریخ در لود اولیه
}
// داده‌های تستی
const testData = {
    doctors: [
        { 
            id: 1, 
            name: 'دکتر رضایی', 
            workHours: [
                { start: '07:00', end: '13:00' },
                { start: '15:00', end: '21:00' }
            ],
            unit: 'A101',
            specialty: 'دندانپزشک عمومی'
        },
        { 
            id: 2, 
            name: 'دکتر محمدی', 
            workHours: [
                { start: '06:00', end: '14:00' },
                { start: '15:00', end: '21:00' }
            ],
            unit: 'B202',
            specialty: 'متخصص ارتودنسی'
        }
    ],
    units: ['A101', 'A102', 'B201', 'B202', 'C301', 'C302'],
    patients: [
        {
            fileNumber: 'P1001',
            firstName: 'علی',
            lastName: 'احمدی',
            nationalCode: '1234567890',
            phone: '09123456789'
        }],
    appointments: [
        {
            id: 1,
            patientName: 'علی احمدی',
            nationalCode: '1234567890',
            phone: '09123456789',
            date: '2024-06-01',
            timeFrom: '09:30',
            timeTo: '10:00',
            status: 'تایید شده',
            description: 'ویزیت عادی',
            doctorId: 1,
            unit: 'A101'
        }
    ]
};



// تنظیمات اولیه
document.addEventListener('DOMContentLoaded', () => {
    initialize();
    currentDate = new Date(); // تنظیم تاریخ اولیه
    currentView = 'week'; // تنظیم نمای پیش‌فرض
    initializeFlatpickr();
    loadDoctorAndUnitData();
    setupEventListeners();
    setupCalendar();
    updateDateRange(); // فراخوانی مستقیم برای نمایش تاریخ در لود اولیه

});
// تابع جدید برای فرمت کردن تاریخ جلالی برای input
function formatJalaliDateForInput([year, month, day]) {
    // اضافه کردن صفر به ابتدای اعداد تک رقمی
    const formattedMonth = month.toString().padStart(2, '0');
    const formattedDay = day.toString().padStart(2, '0');
    return `${year}/${formattedMonth}/${formattedDay}`;
}
// تنظیم Flatpickr برای همه تاریخ‌ها و زمان‌ها
function initializeFlatpickr() {
    // تنظیم برای تاریخ‌ها
    flatpickr('.flatpickr', {
        dateFormat: 'Y/m/d',
        locale: 'fa',
        defaultDate: 'today',
        calendar: 'persian',
        calendarType: 'persian',
        onChange: function(selectedDates, dateStr, instance) {
            // در صورت نیاز می‌توانید اینجا کد اضافی برای مدیریت تغییر تاریخ اضافه کنید
        }
    });

    // تنظیم برای زمان‌ها
    flatpickr('.time-picker', {
        enableTime: true,
        noCalendar: true,
        dateFormat: 'H:i',
        time_24hr: true,
        minuteIncrement: 5
    });
}

// بارگذاری اطلاعات پزشکان و یونیت‌ها
function loadDoctorAndUnitData() {
    const doctorSelect = document.getElementById('visit_doctor');
    const unitSelect = document.getElementById('visit_unit');
    const emergencyButton = document.querySelector('.appointment_button-danger');
    
    // پر کردن لیست پزشکان
    doctorSelect.innerHTML = '<option value="">انتخاب پزشک</option>';
    testData.doctors.forEach(doctor => {
        const option = document.createElement('option');
        option.value = doctor.id;
        option.textContent = `${doctor.name} - ${doctor.specialty} (${doctor.unit})`;
        doctorSelect.appendChild(option);
    });

    // پر کردن لیست یونیت‌ها
    unitSelect.innerHTML = '<option value="">انتخاب یونیت</option>';
    testData.units.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit;
        option.textContent = unit;
        unitSelect.appendChild(option);
    });

    // اضافه کردن event listener برای تغییر دکتر
    doctorSelect.addEventListener('change', function() {
        const selectedDoctor = testData.doctors.find(d => d.id === parseInt(this.value));
        currentDoctor = this.value;
        
        // نمایش/مخفی کردن دکمه اضطراری
        if (emergencyButton) {
            emergencyButton.style.display = this.value ? 'inline-flex' : 'none';
        }

        // به‌روزرسانی یونیت
        if (selectedDoctor) {
            unitSelect.value = selectedDoctor.unit;
        }

        generateTimeSlots();
    });

    // مخفی کردن اولیه دکمه اضطراری
    if (emergencyButton) {
        emergencyButton.style.display = 'none';
    }
}

// تنظیم Event Listeners
function setupEventListeners() {
    // تغییر مدت زمان ویزیت
    document.getElementById('visit_duration').addEventListener('change', function() {
        appointmentDuration = parseInt(this.value);
        generateTimeSlots();
    });

    // تغییر پزشک
    document.getElementById('visit_doctor').addEventListener('change', function() {
        currentDoctor = this.value;
        generateTimeSlots();
    });

    // نمایش اطلاعات بیمار
    document.getElementById('show_patient_info').addEventListener('change', function() {
        showPatientInfo = this.checked;
        showTestAppointments();
    });
}

// به‌روزرسانی تقویم
function setupCalendar() {
    const today = new Date();
    updateCalendarHeader(today);
    generateTimeSlots();
}


// تابع تعیین رنگ بر اساس وضعیت
function getStatusColor(status) {
    const colors = {
        'در انتظار': '#fff3cd',
        'تایید شده': '#d4edda',
        'لغو شده': '#f8d7da',
        'در حال ویزیت': '#cce5ff',
        'تکمیل شده': '#c3e6cb'
    };
    return colors[status] || document.getElementById('visit_color_picker').value || '#ffffff';
}

// اضافه کردن وضعیت‌های پیش‌فرض به select
function setupStatusSelect() {
    const statusSelect = document.getElementById('visit_status');
    const statuses = [
        { value: 'در انتظار', color: '#fff3cd' },
        { value: 'تایید شده', color: '#d4edda' },
        { value: 'لغو شده', color: '#f8d7da' },
        { value: 'در حال ویزیت', color: '#cce5ff' },
        { value: 'تکمیل شده', color: '#c3e6cb' }
    ];

    statusSelect.innerHTML = '<option value="">انتخاب وضعیت</option>';
    statuses.forEach(status => {
        const option = document.createElement('option');
        option.value = status.value;
        option.textContent = status.value;
        option.style.backgroundColor = status.color;
        statusSelect.appendChild(option);
    });
}

// ایجاد اسلات‌های زمانی
function generateTimeSlots() {
    const tbody = document.getElementById('appointment-slots');
    tbody.innerHTML = '';

    const doctor = currentDoctor ? 
        testData.doctors.find(d => d.id === parseInt(currentDoctor)) : 
        { workHours: { start: '08:00', end: '20:00' } };

    const startTime = new Date(`2000-01-01 ${doctor.workHours.start}`);
    const endTime = new Date(`2000-01-01 ${doctor.workHours.end}`);
    const now = new Date();
    const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    while(startTime < endTime) {
        const row = document.createElement('tr');
        const timeCell = document.createElement('td');
        const currentTime = formatTime(startTime);
        
        timeCell.className = 'appointment_header-cell appointment_time-cell';
        
        // بررسی زمان فعلی
        if (currentTime === currentTimeStr && isToday(currentDate)) {
            timeCell.classList.add('appointment_current_time');
            const wrapper = document.createElement('div');
            wrapper.className = 'appointment_time_wrapper';
            wrapper.innerHTML = `
                <span>${currentTime}</span>
                <div class="appointment_time_indicator"></div>
            `;
            timeCell.appendChild(wrapper);
        } else {
            timeCell.textContent = currentTime;
        }
        
        row.appendChild(timeCell);

        // ایجاد سلول‌های روزها
        for(let i = 0; i < getNumberOfDaysToShow(); i++) {
            const cell = document.createElement('td');
            cell.className = 'appointment_time-slot';
            
            // اضافه کردن تاریخ به dataset
            const cellDate = new Date(currentDate);
            cellDate.setDate(currentDate.getDate() + i);
            const jalaliDate = gregorianToJalali(
                cellDate.getFullYear(),
                cellDate.getMonth() + 1,
                cellDate.getDate()
            );
            cell.dataset.date = formatJalaliDateForInput(jalaliDate);
            
            const isAvailable = isTimeSlotAvailable(startTime, i);
            if (!isAvailable) {
                cell.classList.add('unavailable');
            }

            if (isCurrentTimeSlot(startTime, i)) {
                cell.classList.add('current');
            }

            cell.dataset.time = formatTime(startTime);
            cell.dataset.day = i;
            
            if (isAvailable) {
                cell.addEventListener('click', () => openAppointmentModal(cell));
            }

            // هایلایت سلول اگر قرار ملاقات جدید در این زمان و تاریخ است
            const appointments = testData.appointments.filter(app => 
                app.date === cell.dataset.date && 
                app.timeFrom === cell.dataset.time
            );

            if (appointments.length > 0) {
                const appointmentsContainer = document.createElement('div');
                appointmentsContainer.className = 'appointment_items_container';

                appointments.forEach(appointment => {
                    const appointmentElement = document.createElement('div');
                    appointmentElement.className = 'appointment_item';
                    appointmentElement.dataset.appointmentId = appointment.id;
                    appointmentElement.style.backgroundColor = getStatusColor(appointment.status);
                    appointmentElement.innerHTML = `
                        <div class="appointment_item_content">
                            <span class="appointment_patient_name">${appointment.patientName}</span>
                        </div>
                    `;
                    appointmentElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openAppointmentModal(cell, appointment);
                    });
                    appointmentsContainer.appendChild(appointmentElement);
                });

                // اضافه کردن فضای خالی برای قرار جدید
                const emptySpace = document.createElement('div');
                emptySpace.className = 'appointment_empty_space';
                emptySpace.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openAppointmentModal(cell);
                });

                cell.appendChild(appointmentsContainer);
                cell.appendChild(emptySpace);
            }

            row.appendChild(cell);
        }

        tbody.appendChild(row);
        startTime.setMinutes(startTime.getMinutes() + appointmentDuration);
    }
}

// بررسی دسترسی‌پذیری زمان
// بررسی دسترسی‌پذیری زمان
function isTimeSlotAvailable(time, dayOffset) {
    const doctor = currentDoctor ? 
        testData.doctors.find(d => d.id === parseInt(currentDoctor)) : null;

    if (!doctor) return false; // اگر پزشکی انتخاب نشده، همه اسلات‌ها غیرفعال

    const timeStr = formatTime(time);
    return doctor.workHours.some(shift => 
        timeStr >= shift.start && timeStr <= shift.end
    );
}

// تغییر در تابع generateTimeSlots
function generateTimeSlots() {
    const tbody = document.getElementById('appointment-slots');
    tbody.innerHTML = '';

    // نمایش کل ساعات روز
    const startTime = new Date(`2000-01-01 00:00`);
    const endTime = new Date(`2000-01-01 23:59`);
    const interval = parseInt(document.getElementById('visit_duration').value);

    while(startTime < endTime) {
        const row = document.createElement('tr');
        const timeCell = document.createElement('td');
        timeCell.className = 'appointment_header-cell';
        timeCell.textContent = formatTime(startTime);
        row.appendChild(timeCell);

        for(let i = 0; i < getNumberOfDaysToShow(); i++) {
            const cell = document.createElement('td');
            cell.className = 'appointment_time-slot';
            
            // بررسی دسترسی‌پذیری زمان
            const isAvailable = isTimeSlotAvailable(startTime, i);
            if (!isAvailable) {
                cell.classList.add('unavailable');
            }

            // بررسی زمان جاری
            if (isCurrentTimeSlot(startTime, i)) {
                cell.classList.add('current');
            }

            cell.dataset.time = formatTime(startTime);
            cell.dataset.day = i;
            
            if (isAvailable) {
                cell.addEventListener('click', () => openAppointmentModal(cell));
            }

            row.appendChild(cell);
        }

        tbody.appendChild(row);
        startTime.setMinutes(startTime.getMinutes() + interval);
    }

    showTestAppointments();
}

function openAppointmentModal(cell, existingAppointment = null, isEmergency = false) {
    const modal = document.getElementById('appointment-modal');
    selectedTimeSlot = cell;

    // بررسی انتخاب دکتر در حالت اضطراری
    if (isEmergency && !currentDoctor) {
        showNotification('لطفاً ابتدا پزشک را انتخاب کنید', 'error');
        return;
    }

    // پاک کردن فرم
    document.getElementById('visit_appointment_form').reset();

    if (existingAppointment) {
        // پر کردن فرم با اطلاعات قرار موجود
        document.getElementById('visit_firstname').value = existingAppointment.firstName || '';
        document.getElementById('visit_lastname').value = existingAppointment.lastName || '';
        document.getElementById('visit_national_code').value = existingAppointment.nationalCode || '';
        document.getElementById('visit_phone').value = existingAppointment.phone || '';
        document.getElementById('visit_time_from').value = existingAppointment.timeFrom || '';
        document.getElementById('visit_time_to').value = existingAppointment.timeTo || '';
        document.getElementById('visit_status').value = existingAppointment.status || '';
        document.getElementById('visit_description').value = existingAppointment.description || '';
        document.getElementById('visit_file_number').value = existingAppointment.fileNumber || '';
        
        // نمایش دکمه حذف در حالت ویرایش
        const deleteBtn = document.querySelector('.appointment_button-danger');
        if (deleteBtn) {
            deleteBtn.style.display = 'inline-flex';
            deleteBtn.onclick = () => deleteAppointment(existingAppointment.id);
        }
    } else if (isEmergency) {
        // حالت اضطراری
        const selectedDoctor = testData.doctors.find(d => d.id === parseInt(currentDoctor));
        
        // تنظیم اطلاعات پزشک و یونیت
        document.getElementById('visit_modal_doctor').value = selectedDoctor.name;
        document.getElementById('visit_modal_unit').value = selectedDoctor.unit;

        // فعال کردن فیلدهای تاریخ و زمان
        document.getElementById('visit_time_from').readOnly = false;
        document.getElementById('visit_time_to').readOnly = false;
        document.getElementById('visit_appointment_date').readOnly = false;

        // تنظیم تاریخ و زمان پیش‌فرض
        const now = new Date();
        const jalaliNow = gregorianToJalali(
            now.getFullYear(),
            now.getMonth() + 1,
            now.getDate()
        );

        document.getElementById('visit_appointment_date').value = formatJalaliDateForInput(jalaliNow);
        document.getElementById('visit_time_from').value = formatTime(now);

        const endTime = new Date(now);
        endTime.setMinutes(endTime.getMinutes() + appointmentDuration);
        document.getElementById('visit_time_to').value = formatTime(endTime);

        // مخفی کردن دکمه حذف
        const deleteBtn = document.querySelector('.appointment_button-danger');
        if (deleteBtn) {
            deleteBtn.style.display = 'none';
        }
    } else if (cell) {
        // حالت عادی با انتخاب سلول
        const selectedDate = new Date(currentDate);
        selectedDate.setDate(currentDate.getDate() + parseInt(cell.dataset.day));
        
        const jalaliDate = gregorianToJalali(
            selectedDate.getFullYear(),
            selectedDate.getMonth() + 1,
            selectedDate.getDate()
        );

        document.getElementById('visit_appointment_date').value = formatJalaliDateForInput(jalaliDate);
        document.getElementById('visit_time_from').value = cell.dataset.time;
        
        const endTime = new Date(`2000-01-01 ${cell.dataset.time}`);
        endTime.setMinutes(endTime.getMinutes() + appointmentDuration);
        document.getElementById('visit_time_to').value = formatTime(endTime);

        // مخفی کردن دکمه حذف در حالت جدید
        const deleteBtn = document.querySelector('.appointment_button-danger');
        if (deleteBtn) {
            deleteBtn.style.display = 'none';
        }
    }

    // پاک کردن ID قرار ملاقات قبلی در حالت جدید
    if (!existingAppointment) {
        delete modal.dataset.editAppointmentId;
    } else {
        modal.dataset.editAppointmentId = existingAppointment.id;
    }

    modal.style.display = 'block';
}

// تابع کمکی برای فرمت کردن تاریخ جلالی
function formatJalaliDateForInput([year, month, day]) {
    return `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
}
// تابع جدید برای گرد کردن زمان به نزدیک‌ترین بازه
function roundToNearestTimeSlot(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    const totalMinutes = hours * 60 + minutes;
    const interval = parseInt(document.getElementById('visit_duration').value);
    
    // محاسبه نزدیک‌ترین بازه
    const roundedMinutes = Math.round(totalMinutes / interval) * interval;
    
    // تبدیل به ساعت و دقیقه
    const newHours = Math.floor(roundedMinutes / 60);
    const newMinutes = roundedMinutes % 60;
    
    // برگرداندن زمان فرمت‌شده
    return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
}
// ذخیره وقت ملاقات

function saveAppointment() {
    const modal = document.getElementById('appointment-modal');
    const editId = modal.dataset.editAppointmentId;

    // بررسی انتخاب دکتر
    if (!currentDoctor) {
        showNotification('لطفاً ابتدا پزشک را انتخاب کنید', 'error');
        return;
    }

    const selectedDoctor = testData.doctors.find(d => d.id === parseInt(currentDoctor));

    // گرد کردن زمان‌ها به نزدیک‌ترین بازه
    const timeFrom = roundToNearestTimeSlot(document.getElementById('visit_time_from').value);
    const timeTo = roundToNearestTimeSlot(document.getElementById('visit_time_to').value);

    const formData = {
        id: editId ? parseInt(editId) : Date.now(),
        fileNumber: document.getElementById('visit_file_number').value,
        firstName: document.getElementById('visit_firstname').value,
        lastName: document.getElementById('visit_lastname').value,
        nationalCode: document.getElementById('visit_national_code').value,
        phone: document.getElementById('visit_phone').value,
        timeFrom: timeFrom, // استفاده از زمان گرد شده
        timeTo: timeTo, // استفاده از زمان گرد شده
        date: document.getElementById('visit_appointment_date').value,
        status: document.getElementById('visit_status').value,
        description: document.getElementById('visit_description').value,
        visited: document.getElementById('visit_patient_visited').checked,
        noFile: document.getElementById('visit_no_file').checked,
        doctorId: currentDoctor,
        doctorName: selectedDoctor.name,
        unit: document.getElementById('visit_unit').value,
        patientName: `${document.getElementById('visit_firstname').value} ${document.getElementById('visit_lastname').value}`
    };

    // اعتبارسنجی داده‌ها (بدون بررسی تداخل زمانی)
    if (!validateAppointmentData(formData)) {
        return;
    }

    if (editId) {
        // ویرایش قرار موجود
        const index = testData.appointments.findIndex(a => a.id === parseInt(editId));
        if (index !== -1) {
            testData.appointments[index] = formData;
        }
    } else {
        // افزودن قرار جدید
        testData.appointments.push(formData);
    }

    // به‌روزرسانی نمایش
    generateTimeSlots();

    // اسکرول به موقعیت قرار جدید
    setTimeout(() => {
        const cells = document.querySelectorAll('.appointment_time-slot');
        cells.forEach(cell => {
            if (cell.dataset.time === formData.timeFrom && 
                cell.dataset.date === formData.date) {
                cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // هایلایت موقت سلول
                cell.style.transition = 'background-color 0.3s ease';
                const originalColor = cell.style.backgroundColor;
                cell.style.backgroundColor = '#e3f2fd';
                setTimeout(() => {
                    cell.style.backgroundColor = originalColor;
                }, 1500);
            }
        });
    }, 100);

    showNotification('وقت ملاقات با موفقیت ثبت شد', 'success');
    closeModal();
}

// آپدیت تابع updateAppointmentSlot برای نمایش اطلاعات دکتر در tooltip
function updateAppointmentSlot(cell, appointments) {
    if (!cell) return;

    // پاک کردن محتوای قبلی سلول
    cell.innerHTML = '';

    // ایجاد container برای قرارها
    const appointmentsContainer = document.createElement('div');
    appointmentsContainer.className = 'appointment_items_container';

    appointments.forEach(appointment => {
        const appointmentElement = document.createElement('div');
        appointmentElement.className = 'appointment_item';
        appointmentElement.dataset.appointmentId = appointment.id;
        appointmentElement.style.backgroundColor = getStatusColor(appointment.status);

        appointmentElement.innerHTML = `
            <div class="appointment_item_content">
                <span class="appointment_patient_name">${appointment.patientName}</span>
            </div>
        `;

        // اضافه کردن tooltip با اطلاعات دکتر
        appointmentElement.title = `
            نام: ${appointment.patientName}
            پزشک: ${appointment.doctorName}
            یونیت: ${appointment.unit}
            کد ملی: ${appointment.nationalCode}
            تلفن: ${appointment.phone}
            وضعیت: ${appointment.status}
            ${appointment.description ? 'توضیحات: ' + appointment.description : ''}
        `;

        appointmentElement.addEventListener('click', (e) => {
            e.stopPropagation();
            openAppointmentModal(cell, appointment);
        });

        appointmentsContainer.appendChild(appointmentElement);
    });

    // اضافه کردن فضای خالی برای قرار جدید
    const emptySpace = document.createElement('div');
    emptySpace.className = 'appointment_empty_space';
    emptySpace.addEventListener('click', (e) => {
        e.stopPropagation();
        openAppointmentModal(cell);
    });

    cell.appendChild(appointmentsContainer);
    cell.appendChild(emptySpace);
}


// اعتبارسنجی داده‌های فرم
function validateAppointmentData(data) {
    const requiredFields = {
        'نام': data.firstName,
        'نام خانوادگی': data.lastName,
        'کد ملی': data.nationalCode,
        'شماره تماس': data.phone,
        'تاریخ': data.date,
        'زمان شروع': data.timeFrom,
        'زمان پایان': data.timeTo
    };

    for (const [fieldName, value] of Object.entries(requiredFields)) {
        if (!value || value.trim() === '') {
            showNotification(`لطفاً ${fieldName} را وارد کنید`, 'error');
            return false;
        }
    }

    // اعتبارسنجی کد ملی
    if (!/^\d{10}$/.test(data.nationalCode)) {
        showNotification('کد ملی باید 10 رقم باشد', 'error');
        return false;
    }

    // اعتبارسنجی شماره تماس
   // if (!/^09\d{9}$/.test(data.phone)) {
   //     showNotification('شماره تماس معتبر نیست', 'error');
   //     return false;
   // }

    return true;
}
// به‌روزرسانی ظاهر سلول وقت ملاقات

function updateAppointmentSlot(cell, appointments) {
    if (!cell) return;

    // پاک کردن محتوای قبلی سلول
    cell.innerHTML = '';

    // ایجاد container برای قرارها
    const appointmentsContainer = document.createElement('div');
    appointmentsContainer.className = 'appointment_items_container';

    // اضافه کردن قرارهای موجود
    if (appointments && appointments.length > 0) {
        appointments.forEach(appointment => {
            const appointmentElement = document.createElement('div');
            appointmentElement.className = 'appointment_item';
            appointmentElement.dataset.appointmentId = appointment.id;
            appointmentElement.style.backgroundColor = getStatusColor(appointment.status);

            appointmentElement.innerHTML = `
                <div class="appointment_item_content">
                    <span class="appointment_patient_name">${appointment.patientName}</span>
                </div>
            `;

            // اضافه کردن tooltip
            appointmentElement.title = `
                نام: ${appointment.patientName}
                کد ملی: ${appointment.nationalCode}
                تلفن: ${appointment.phone}
                وضعیت: ${appointment.status}
                ${appointment.description ? 'توضیحات: ' + appointment.description : ''}
            `;

            // اضافه کردن event listener برای ویرایش
            appointmentElement.addEventListener('click', (e) => {
                e.stopPropagation();
                openAppointmentModal(cell, appointment);
            });

            appointmentsContainer.appendChild(appointmentElement);
        });
    }

    // اضافه کردن فضای خالی برای قرار جدید
    const emptySpace = document.createElement('div');
    emptySpace.className = 'appointment_empty_space';
    emptySpace.addEventListener('click', (e) => {
        e.stopPropagation();
        openAppointmentModal(cell);
    });

    // اضافه کردن به سلول
    cell.appendChild(appointmentsContainer);
    cell.appendChild(emptySpace);
}


// نمایش پیام‌های سیستم
function showNotification(message, type = 'info') {
    const colors = {
        success: '#4CAF50',
        error: '#F44336',
        warning: '#FFC107',
        info: '#2196F3'
    };

    // اگر از کتابخانه‌ای مثل toastr استفاده نمی‌کنید، می‌توانید از alert استفاده کنید
    alert(message);
}

// اضافه کردن داده‌های تستی بیشتر
testData.patients = [
    {
        fileNumber: 'P1001',
        firstName: 'علی',
        lastName: 'احمدی',
        nationalCode: '1234567890',
        phone: '09123456789'
    },
    {
        fileNumber: 'P1002',
        firstName: 'مریم',
        lastName: 'محمدی',
        nationalCode: '0987654321',
        phone: '09187654321'
    },
    {
        fileNumber: 'P1003',
        firstName: 'رضا',
        lastName: 'کریمی',
        nationalCode: '1122334455',
        phone: '09151234567'
    }
];

// اضافه کردن event listener برای فیلد جستجو
document.getElementById('visit_patient_search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchPatient();
    }
});

// توابع کمکی
function formatDate(date) {
    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
}

function formatTime(date) {
    return date.toTimeString().slice(0, 5);
}

function isToday(date) {
    const today = new Date();
    return date.getDate() === today.getDate() &&
           date.getMonth() === today.getMonth() &&
           date.getFullYear() === today.getFullYear();
}

function isCurrentTimeSlot(time, dayOffset) {
    if (dayOffset !== 0) return false;
    
    const now = new Date();
    const timeStr = formatTime(time);
    const currentTime = formatTime(now);
    return timeStr === currentTime;
}

function getNumberOfDaysToShow() {
    switch(currentView) {
        case 'day': return 1;
        case 'week': return 7;
        case 'month': return new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        default: return 7;
    }
}



// بستن مودال
function closeModal() {
    document.getElementById('appointment-modal').style.display = 'none';
    selectedTimeSlot = null;
}

// ارسال پیامک
function sendSMS() {
    alert('سیستم ارسال پیامک در حال پیاده‌سازی است');
}


// تابع جستجوی بیمار با نمایش نتایج
function searchPatient() {
    const searchTerm = document.getElementById('visit_patient_search').value.trim();
    if (!searchTerm) {
        showNotification('لطفاً عبارت جستجو را وارد کنید', 'warning');
        return;
    }

    // جستجو در داده‌های تستی
    const patient = testData.patients.find(p => 
        p.fileNumber.toLowerCase().includes(searchTerm.toLowerCase()) || 
        p.nationalCode.includes(searchTerm) || 
        p.phone.includes(searchTerm) ||
        `${p.firstName} ${p.lastName}`.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (patient) {
        fillPatientData(patient);
        showNotification('اطلاعات بیمار با موفقیت یافت شد', 'success');
    } else {
        showNotification('بیمار مورد نظر یافت نشد', 'error');
    }
}

// پر کردن فرم با اطلاعات بیمار
function fillPatientData(patient) {
    const fields = {
        'visit_file_number': patient.fileNumber,
        'visit_firstname': patient.firstName,
        'visit_lastname': patient.lastName,
        'visit_national_code': patient.nationalCode,
        'visit_phone': patient.phone
    };

    for (const [fieldId, value] of Object.entries(fields)) {
        const element = document.getElementById(fieldId);
        if (element) {
            element.value = value;
        }
    }
}
// متغیرهای سراسری جدید
let currentDate = new Date();
let currentOffset = 0;

// تابع ناوبری تقویم
// آپدیت تابع navigateCalendar برای حالت سال
function navigateCalendar(direction) {
    const offset = direction === 'next' ? 1 : -1;
    
    switch(currentView) {
        case 'week':
            currentOffset += offset;
            currentDate = new Date();
            currentDate.setDate(currentDate.getDate() + (currentOffset * 7));
            break;
            
        case 'month':
            currentDate = new Date(
                currentDate.getFullYear(),
                currentDate.getMonth() + offset,
                1
            );
            break;
            
        case 'year':
            // تبدیل به تاریخ جلالی
            const jalaliDate = gregorianToJalali(
                currentDate.getFullYear(),
                currentDate.getMonth() + 1,
                currentDate.getDate()
            );
            
            // تغییر سال جلالی
            const newJalaliYear = jalaliDate[0] + offset;
            
            // تبدیل به میلادی
            const newGregorian = jalaliToGregorian(newJalaliYear, 1, 1);
            currentDate = new Date(newGregorian[0], newGregorian[1] - 1, newGregorian[2]);
            break;
    }
    
    updateDateRange();
    setupCalendar();
}

// تابع تبدیل تاریخ جلالی به میلادی
function jalaliToGregorian(jy, jm, jd) {
    jy = parseInt(jy);
    jm = parseInt(jm);
    jd = parseInt(jd);
    
    var sal_a, gy, gm, gd, days;
    jy += 1595;
    days = -355668 + (365 * jy) + (parseInt(jy / 33) * 8) + parseInt(((jy % 33) + 3) / 4);
    
    for (var i = 0; i < jm; ++i) {
        days += (i < 6) ? 31 : 30;
    }
    
    days += jd;
    gy = 400 * parseInt(days / 146097);
    days %= 146097;
    
    if (days > 36524) {
        gy += 100 * parseInt(--days / 36524);
        days %= 36524;
        
        if (days >= 365) {
            days++;
        }
    }
    
    gy += 4 * parseInt(days / 1461);
    days %= 1461;
    
    if (days > 365) {
        gy += parseInt((days - 1) / 365);
        days = (days - 1) % 365;
    }
    
    gd = days + 1;
    
    var sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    
    for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) {
        gd -= sal_a[gm];
    }
    
    return [gy, gm, gd];
}

// آپدیت تابع updateDateRange
function updateDateRange() {
    const dateRangeElement = document.getElementById('current-date-range');
    const today = new Date();
    const todayJalali = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
    const currentJalali = gregorianToJalali(currentDate.getFullYear(), currentDate.getMonth() + 1, currentDate.getDate());
    
    let currentDateText = '';
    switch(currentView) {
        case 'day':
            currentDateText = formatJalaliDate(currentJalali);
            break;
            
        case 'week':
            const weekStart = new Date(currentDate);
            const weekEnd = new Date(currentDate);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weekStartJalali = gregorianToJalali(weekStart.getFullYear(), weekStart.getMonth() + 1, weekStart.getDate());
            const weekEndJalali = gregorianToJalali(weekEnd.getFullYear(), weekEnd.getMonth() + 1, weekEnd.getDate());
            
            currentDateText = `${formatJalaliDate(weekStartJalali)} - ${formatJalaliDate(weekEndJalali)}`;
            break;
            
        case 'month':
            currentDateText = `${getPersianMonth(currentJalali[1]-1)} ${currentJalali[0]}`;
            break;
            
        case 'year':
            currentDateText = currentJalali[0];
            break;
    }

    // اضافه کردن تاریخ امروز
    dateRangeElement.innerHTML = `
        <div class="appointment_date-container">
            <div class="appointment_current-range">${currentDateText}</div>
            <div class="appointment_today-date">امروز: ${formatJalaliDate(todayJalali)}</div>
        </div>
    `;
}

// تبدیل تاریخ به فرمت فارسی
function formatPersianDate(date) {
    const jalaliDate = gregorianToJalali(
        date.getFullYear(),
        date.getMonth() + 1,
        date.getDate()
    );
    return formatJalaliDate(jalaliDate);
}

// نام ماه‌های فارسی
function getPersianMonth(monthIndex) {
    const months = [
        'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
        'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
    ];
    return months[monthIndex];
}

// آپدیت تابع showToday
function showToday() {
    currentView = 'day';
    currentDate = new Date();
    currentOffset = 0;
    updateDateRange();
    setupCalendar();
}

// آپدیت تابع showWeek
function showWeek() {
    currentView = 'week';
    updateDateRange();
    setupCalendar();
}

// آپدیت تابع showMonth
function showMonth() {
    currentView = 'month';
    updateDateRange();
    setupCalendar();
}

// آپدیت تابع showYear
function showYear() {
    currentView = 'year';
    // تنظیم تاریخ جاری به سال جلالی فعلی
    const today = new Date();
    const jalaliToday = gregorianToJalali(
        today.getFullYear(),
        today.getMonth() + 1,
        today.getDate()
    );
    
    // تنظیم تاریخ به اول فروردین سال جاری
    const newGregorian = jalaliToGregorian(jalaliToday[0], 1, 1);
    currentDate = new Date(newGregorian[0], newGregorian[1] - 1, newGregorian[2]);
    
    updateDateRange();
    setupCalendar();
}

// آپدیت تابع setupCalendar
function setupCalendar() {
    updateCalendarHeader(currentDate);
    generateTimeSlots();
}

// آپدیت تابع updateCalendarHeader
function updateCalendarHeader(date) {
    const daysHeader = document.getElementById('days-header');
    const datesHeader = document.getElementById('dates-header');
    
    // پاک کردن هدرهای قبلی
    while(daysHeader.children.length > 1) {
        daysHeader.removeChild(daysHeader.lastChild);
        datesHeader.removeChild(datesHeader.lastChild);
    }

    const days = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
    const numberOfDays = getNumberOfDaysToShow();

    // محاسبه تاریخ جلالی سال جاری برای نمای سال
    const baseJalaliDate = gregorianToJalali(
        currentView === 'year' ? date.getFullYear() - 1 : date.getFullYear(),
        date.getMonth() + 1,
        date.getDate()
    );

    for(let i = 0; i < numberOfDays; i++) {
        const currentDate = new Date(date);
        currentDate.setDate(date.getDate() + i);
        
        // محاسبه تاریخ جلالی برای هر روز
        const currentJalali = gregorianToJalali(
            currentDate.getFullYear(),
            currentDate.getMonth() + 1,
            currentDate.getDate()
        );

        // ایجاد سلول روز هفته
        const dayTh = document.createElement('th');
        dayTh.className = 'appointment_header-cell';
        dayTh.textContent = days[currentDate.getDay()];
        
        // ایجاد سلول تاریخ
        const dateTh = document.createElement('th');
        dateTh.className = 'appointment_header-cell';
        
        // تنظیم نمایش تاریخ بر اساس نوع نما
        if (currentView === 'year') {
            dateTh.textContent = `${currentJalali[2]} ${getPersianMonth(currentJalali[1]-1)} ${baseJalaliDate[0]}`;
        } else {
            dateTh.textContent = `${currentJalali[2]} ${getPersianMonth(currentJalali[1]-1)} ${currentJalali[0]}`;
        }

        // اضافه کردن کلاس برای روز جاری
        if (isToday(currentDate)) {
            dayTh.classList.add('current-day');
            dateTh.classList.add('current-day');
        }

        // اضافه کردن به DOM
        daysHeader.appendChild(dayTh);
        datesHeader.appendChild(dateTh);
    }
}



// تابع تبدیل تاریخ میلادی به شمسی
function gregorianToJalali(gy, gm, gd) {
    var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
    var jy = (gy <= 1600) ? 0 : 979;
    gy -= (gy <= 1600) ? 621 : 1600;
    var gy2 = (gm > 2) ? (gy + 1) : gy;
    var days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) +
        (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
    jy += 33 * (parseInt(days / 12053));
    days %= 12053;
    jy += 4 * (parseInt(days / 1461));
    days %= 1461;
    jy += parseInt((days - 1) / 365);
    if (days > 365) days = (days - 1) % 365;
    var jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
    var jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
    return [jy, jm, jd];
}

// آپدیت HTML برای نمایش تاریخ امروز
function updateDateRange() {
    const dateRangeElement = document.getElementById('current-date-range');
    const today = new Date();
    const todayJalali = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
    
    let currentDateText = '';
    switch(currentView) {
        case 'day':
            const dayJalali = gregorianToJalali(currentDate.getFullYear(), currentDate.getMonth() + 1, currentDate.getDate());
            currentDateText = formatJalaliDate(dayJalali);
            break;
            
        case 'week':
            const weekStart = new Date(currentDate);
            const weekEnd = new Date(currentDate);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const weekStartJalali = gregorianToJalali(weekStart.getFullYear(), weekStart.getMonth() + 1, weekStart.getDate());
            const weekEndJalali = gregorianToJalali(weekEnd.getFullYear(), weekEnd.getMonth() + 1, weekEnd.getDate());
            currentDateText = `${formatJalaliDate(weekStartJalali)} - ${formatJalaliDate(weekEndJalali)}`;
            break;
            
        case 'month':
            const monthJalali = gregorianToJalali(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            currentDateText = `${getPersianMonth(monthJalali[1]-1)} ${monthJalali[0]}`;
            break;
            
        case 'year':
            const yearJalali = gregorianToJalali(currentDate.getFullYear(), 1, 1);
            currentDateText = yearJalali[0];
            break;
    }

    // اضافه کردن تاریخ امروز
    dateRangeElement.innerHTML = `
        <div class="appointment_daشمسیte-container">
            <div class="appointment_current-range">${currentDateText}</div>
            <div class="appointment_today-date">امروز: ${formatJalaliDate(todayJalali)}</div>
        </div>
    `;
}

// فرمت‌بندی تاریخ شمسی
function formatJalaliDate([year, month, day]) {
    return `${day} ${getPersianMonth(month-1)} ${year}`;
}


</script>
<script>
function showTestAppointments() {
    // پاک کردن نمایش قبلی
    document.querySelectorAll('.appointment_time-slot').forEach(cell => {
        cell.innerHTML = '';
    });

    // گروه‌بندی قرارهای ملاقات بر اساس تاریخ و زمان
    const appointmentGroups = {};
    
    testData.appointments.forEach(appointment => {
        const key = `${appointment.date}_${appointment.timeFrom}`;
        if (!appointmentGroups[key]) {
            appointmentGroups[key] = [];
        }
        appointmentGroups[key].push(appointment);
    });

    // نمایش قرارهای ملاقات گروه‌بندی شده
    Object.entries(appointmentGroups).forEach(([key, appointments]) => {
        if (appointments.length > 0) {
            const [date, time] = key.split('_');
            const cells = document.querySelectorAll('.appointment_time-slot');
            
            cells.forEach(cell => {
                // چک کردن تاریخ و زمان سلول
                const cellDate = getCellDate(cell);
                if (cell.dataset.time === time && cellDate === date) {
                    // ایجاد container برای قرارها
                    const appointmentsContainer = document.createElement('div');
                    appointmentsContainer.className = 'appointment_items_container';

                    // اضافه کردن هر قرار
                    appointments.forEach(appointment => {
                        const appointmentElement = document.createElement('div');
                        appointmentElement.className = 'appointment_item';
                        appointmentElement.dataset.appointmentId = appointment.id;
                        appointmentElement.style.backgroundColor = getStatusColor(appointment.status);

                        appointmentElement.innerHTML = `
                            <div class="appointment_item_content">
                                <span class="appointment_patient_name">${appointment.patientName}</span>
                            </div>
                        `;

                        appointmentElement.title = `
                            نام: ${appointment.patientName}
                            کد ملی: ${appointment.nationalCode}
                            تلفن: ${appointment.phone}
                            وضعیت: ${appointment.status}
                            ${appointment.description ? 'توضیحات: ' + appointment.description : ''}
                        `;

                        appointmentElement.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openAppointmentModal(cell, appointment);
                        });

                        appointmentsContainer.appendChild(appointmentElement);
                    });

                    // اضافه کردن فضای خالی
                    const emptySpace = document.createElement('div');
                    emptySpace.className = 'appointment_empty_space';
                    emptySpace.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openAppointmentModal(cell);
                    });

                    cell.appendChild(appointmentsContainer);
                    cell.appendChild(emptySpace);
                }
            });
        }
    });
}

// تابع کمکی برای محاسبه تاریخ سلول
function getCellDate(cell) {
    const dayIndex = parseInt(cell.dataset.day);
    const date = new Date(currentDate);
    date.setDate(date.getDate() + dayIndex);
    
    // تبدیل به تاریخ جلالی
    const jalaliDate = gregorianToJalali(
        date.getFullYear(),
        date.getMonth() + 1,
        date.getDate()
    );
    
    // فرمت کردن تاریخ به صورت YYYY/MM/DD
    return `${jalaliDate[0]}/${String(jalaliDate[1]).padStart(2, '0')}/${String(jalaliDate[2]).padStart(2, '0')}`;
}


// توابع ویرایش و حذف
function editAppointment(appointmentId) {
    const appointment = testData.appointments.find(a => a.id === appointmentId);
    if (appointment) {
        // پر کردن مودال با اطلاعات قرار ملاقات
        document.getElementById('visit_firstname').value = appointment.firstName || '';
        document.getElementById('visit_lastname').value = appointment.lastName || '';
        document.getElementById('visit_national_code').value = appointment.nationalCode || '';
        document.getElementById('visit_phone').value = appointment.phone || '';
        document.getElementById('visit_time_from').value = appointment.timeFrom || '';
        document.getElementById('visit_time_to').value = appointment.timeTo || '';
        document.getElementById('visit_status').value = appointment.status || '';
        document.getElementById('visit_description').value = appointment.description || '';
        
        // نمایش مودال
        const modal = document.getElementById('appointment-modal');
        modal.style.display = 'block';
        
        // ذخیره ID قرار ملاقات برای به‌روزرسانی
        modal.dataset.editAppointmentId = appointmentId;
    }
}

function deleteAppointment(appointmentId) {
    if (confirm('آیا از حذف این قرار ملاقات اطمینان دارید؟')) {
        const index = testData.appointments.findIndex(a => a.id === appointmentId);
        if (index !== -1) {
            testData.appointments.splice(index, 1);
            setupCalendar(); // به‌روزرسانی نمایش
        }
    }
}

// تابع کمکی برای پیدا کردن سلول مناسب برای قرار ملاقات
function findAppointmentCell(appointment) {
    const timeStr = appointment.timeFrom;
    const appointmentDate = new Date(appointment.date);
    const today = new Date();
    const diffDays = Math.floor((appointmentDate - today) / (1000 * 60 * 60 * 24));
    
    const cells = document.querySelectorAll('.appointment_time-slot');
    return Array.from(cells).find(cell => 
        cell.dataset.time === timeStr && 
        parseInt(cell.dataset.day) === diffDays
    );
}

// تابع حذف قرار ملاقات
function deleteAppointment(appointmentId) {
    if (confirm('آیا از حذف این وقت ملاقات اطمینان دارید؟')) {
        const index = testData.appointments.findIndex(a => a.id === appointmentId);
        if (index !== -1) {
            testData.appointments.splice(index, 1);
            document.getElementById('appointment-modal').style.display = 'none';
            setupCalendar(); // به‌روزرسانی نمایش
        }
    }
}
</script>

</body>
</html>
