{% load static %}
{% load humanize %}

{% block content %}
<div class="treatment-container">
    <!-- اطلاعات بیمار -->
    <div class="patient-info-card">
        <div class="patient-info-header">
            <h3>اطلاعات بیمار</h3>
            <a href="{% url 'Patient:patient_detail' patient.id %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-user"></i> مشاهده پرونده
            </a>
        </div>
        <div class="patient-info-body">
            <div class="patient-info-row">
                <div class="patient-info-item">
                    <span class="info-label">نام و نام خانوادگی:</span>
                    <span class="info-value">{{ patient.name }} {{ patient.family }}</span>
                    <input type="hidden" id="patient-name" value="{{ patient.name }} {{ patient.family }}">
                    <input type="hidden" id="patient-id" value="{{ patient.id }}">
                </div>
                <div class="patient-info-item">
                    <span class="info-label">شماره پرونده:</span>
                    <span class="info-value">{{ patient.file_num }}</span>
                </div>
                <div class="patient-info-item">
                    <span class="info-label">کد ملی:</span>
                    <span class="info-value">{{ patient.national_code }}</span>
                </div>
            </div>
            <div class="patient-info-row">
                <div class="patient-info-item">
                    <span class="info-label">سن:</span>
                    <span class="info-value">{{ patient.get_age }} سال</span>
                </div>
                <div class="patient-info-item">
                    <span class="info-label">جنسیت:</span>
                    <span class="info-value">{% if patient.sex %}مرد{% else %}زن{% endif %}</span>
                </div>
                <div class="patient-info-item">
                    <span class="info-label">تلفن تماس:</span>
                    <span class="info-value">{{ patient.contant_info }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- انتخاب نوع چارت -->
    <div class="chart-type-selector">
        <button class="chart-type-btn active" data-chart="adult_teeth">
            <i class="fas fa-tooth"></i> دندان بزرگسال
        </button>
        <button class="chart-type-btn" data-chart="child_teeth">
            <i class="fas fa-baby"></i> دندان کودک
        </button>
        <button class="chart-type-btn" data-chart="face">
            <i class="fas fa-smile"></i> زیبایی صورت
        </button>
        <button class="chart-type-btn" data-chart="body">
            <i class="fas fa-user"></i> اعضای بدن
        </button>
    </div>

    <div class="charts-container">
        <div class="dental-chart" data-type="adult_teeth" style="display:block;">
            {% include 'Treatment/charts/_adult_teeth_chart.html' %}
        </div>
        <div class="dental-chart" data-type="child_teeth" style="display:none;">
            {% include 'Treatment/charts/_child_teeth_chart.html' %}
        </div>
        <div class="dental-chart" data-type="face" style="display:none;">
            {% include 'Treatment/charts/_face_chart.html' %}
        </div>
        <div class="dental-chart" data-type="body" style="display:none;">
            {% include 'Treatment/charts/_body_chart.html' %}
        </div>
    </div>

    <!-- سیستم شماره‌گذاری دندان -->
    <div class="dental-numbering-system">
        <label class="dental-radio-label">
            <input type="radio" name="numberingSystem" value="iranian" checked>
            سیستم شماره‌گذاری ایرانی
        </label>
        <label class="dental-radio-label">
            <input type="radio" name="numberingSystem" value="american">
            سیستم شماره‌گذاری آمریکایی
        </label>
    </div>

    <!-- دکمه‌های انتخاب سریع -->
    <div class="dental-quick-select">
        <button class="dental-select-btn" data-select="all">انتخاب همه</button>
        <button class="dental-select-btn" data-select="upper">انتخاب فک بالا</button>
        <button class="dental-select-btn" data-select="lower">انتخاب فک پایین</button>
        <button class="dental-select-btn" data-select="none">حذف انتخاب‌ها</button>
    </div>

    <!-- گزینه‌های درمان -->
    <div class="treatment-options">
        <div class="checkbox-group">
            <label class="treatment-checkbox">
                <input type="checkbox" id="is-treatment-plan">
                <span class="checkmark"></span>
                ثبت به عنوان طرح درمان
            </label>
        </div>
    </div>

    <!-- فرم درمان -->
    {% include 'Treatment/forms/_treatment_form.html' %}

    <!-- دکمه تنظیمات ستون‌ها -->
    <div class="table-settings">
        <button class="settings-btn" onclick="TreatmentUI.openColumnSettings()">
            <i class="fas fa-cog"></i>
            تنظیمات نمایش ستون‌ها
        </button>
    </div>

    <!-- جدول درمان‌ها -->
    <div class="treatment-table-container">
        <table class="treatment-table" id="treatment-plan-list">
            <thead>
                <tr>
                    <th>ردیف</th>
                    <th>تاریخ</th>
                    <th>نواحی درمان</th>
                    <th>نوع درمان</th>
                    <th>شرح درمان</th>
                    <th>پزشک معالج</th>
                    <th>دستیار</th>
                    <th>تعرفه عمومی</th>
                    <th>تعرفه تخصصی</th>
                    <th>تخفیف</th>
                    <th>هزینه مواد</th>
                    <th>هزینه لابراتور</th>
                    <th>مبلغ قابل پرداخت</th>
                    <th>وضعیت بیمه</th>
                    <th>وضعیت درمان</th>
                    <th>تاریخ مراجعه بعدی</th>
                    <th>نوع مراجعه</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
                {% for treatment in patient.treatments.all %}
                <tr data-id="{{ treatment.id }}">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ treatment.treatment_date|date:"Y/m/d" }}</td>
                    <td>{{ treatment.treatment_areas }}</td>
                    <td>{{ treatment.treatment_type.title }}</td>
                    <td>{{ treatment.treatment_detail.description }}</td>
                    <td>{{ treatment.doctor.get_full_name }}</td>
                    <td>{{ treatment.assistant.get_full_name|default:"-" }}</td>
                    <td>{{ treatment.general_fee|floatformat:0|intcomma }} ریال</td>
                    <td>{{ treatment.special_fee|floatformat:0|intcomma }} ریال</td>
                    <td>{{ treatment.discount|floatformat:0|intcomma }} ریال</td>
                    <td>{{ treatment.material_cost|floatformat:0|intcomma }} ریال</td>
                    <td>{{ treatment.lab_cost|floatformat:0|intcomma }} ریال</td>
                    <td>{{ treatment.payable_amount|floatformat:0|intcomma }} ریال</td>
                    <td>
                        {% if treatment.insurance_sent %}
                            {% if treatment.insurance_paid %}
                                <span class="status-badge success">پرداخت شده</span>
                            {% else %}
                                <span class="status-badge warning">ارسال شده</span>
                            {% endif %}
                        {% else %}
                            <span class="status-badge danger">ارسال نشده</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if treatment.is_completed %}
                            <span class="status-badge success">انجام شده</span>
                        {% else %}
                            <span class="status-badge warning">در انتظار</span>
                        {% endif %}
                    </td>
                    <td>{{ treatment.next_visit_date|date:"Y/m/d"|default:"-" }}</td>
                    <td>
                        <span class="status-badge {% if treatment.is_treatment_plan %}info{% else %}primary{% endif %}">
                            {% if treatment.is_treatment_plan %}طرح درمان{% else %}درمان{% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" title="ویرایش" data-id="{{ treatment.id }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" title="حذف" data-id="{{ treatment.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="action-btn print" title="پرینت" data-id="{{ treatment.id }}">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="action-btn payment" title="پرداخت" data-id="{{ treatment.id }}" data-amount="{{ treatment.payable_amount }}">
                                <i class="fas fa-money-bill"></i>
                            </button>
                            <button class="action-btn invoice" title="صدور فاکتور" data-id="{{ treatment.id }}">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="18" class="empty-table">هیچ درمانی ثبت نشده است</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- مودال تنظیمات ستون‌ها -->
    <div class="settings-modal" id="columnSettingsModal">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h3>تنظیمات نمایش ستون‌ها</h3>
                <button class="modal-close" onclick="TreatmentUI.closeColumnSettings()">×</button>
            </div>
            <div class="settings-modal-body">
                <div class="columns-list">
                    <div class="column-item">
                        <label class="column-checkbox-label">
                            <input type="checkbox" class="column-checkbox" data-column="0" checked>
                            <span class="column-name">ردیف</span>
                        </label>
                    </div>
                    <!-- سایر ستون‌ها -->
                </div>
            </div>
            <div class="settings-modal-footer">
                <button class="save-settings" onclick="TreatmentUI.saveColumnSettings()">ذخیره تنظیمات</button>
            </div>
        </div>
    </div>

    <!-- مودال پرداخت -->
    <div class="payment-modal">
        <div class="payment-modal-content">
            <div class="payment-modal-header">
                <h3>ثبت پرداخت</h3>
                <button class="modal-close" onclick="TreatmentUI.closePaymentModal()">×</button>
            </div>
            <div class="payment-modal-body">
                <form class="payment-form">
                    <input type="hidden" name="treatment_id" id="payment-treatment-id">
                    
                    <div class="payment-form-group">
                        <label>مبلغ قابل پرداخت</label>
                        <input type="text" name="total_amount" readonly>
                    </div>
                    
                    <div class="payment-form-group">
                        <label>مبلغ پرداختی</label>
                        <input type="number" name="amount" required>
                    </div>
                    
                    <div class="payment-form-group">
                        <label>تاریخ پرداخت</label>
                        <input type="date" name="payment_date" required value="{{ today|date:'Y-m-d' }}">
                    </div>
                    
                    <div class="payment-form-group">
                        <label>روش پرداخت</label>
                        <select name="payment_method" id="paymentMethod" required>
                            <option value="cash">نقدی</option>
                            <option value="card">کارت به کارت</option>
                            <option value="pos">کارتخوان</option>
                            <option value="check">چک</option>
                        </select>
                    </div>
                    
                    <div id="checkFields" class="check-fields">
                        <div class="payment-form-group">
                            <label>شماره چک</label>
                            <input type="text" name="check_number">
                        </div>
                        
                        <div class="payment-form-group">
                            <label>تاریخ چک</label>
                            <input type="date" name="check_date">
                        </div>
                        
                        <div class="payment-form-group">
                            <label>بانک</label>
                            <input type="text" name="check_bank">
                        </div>
                    </div>
                    
                    <div class="payment-form-group">
                        <label>توضیحات</label>
                        <textarea name="description"></textarea>
                    </div>
                    
                    <div class="payment-form-actions">
                        <button type="submit" class="payment-submit">ثبت پرداخت</button>
                        <button type="button" class="payment-cancel" onclick="TreatmentUI.closePaymentModal()">انصراف</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- مودال تغییر وضعیت دندان -->
    <div class="dental-icon-modal">
        <div class="dental-modal-content">
            <div class="dental-modal-header">
                <h3>انتخاب وضعیت دندان</h3>
                <button class="dental-modal-close">×</button>
            </div>
            <div class="dental-modal-body">
                <div class="dental-icon-grid">
                    <div class="dental-icon-option" data-icon="tooth">
                        <i class="fas fa-tooth"></i>
                        <span>دندان سالم</span>
                    </div>
                    <div class="dental-icon-option" data-icon="implant">
                        <i class="fas fa-teeth"></i>
                        <span>ایمپلنت</span>
                    </div>
                    <div class="dental-icon-option" data-icon="missing">
                        <i class="fas fa-times"></i>
                        <span>دندان از دست رفته</span>
                    </div>
                    <div class="dental-icon-option" data-icon="crown">
                        <i class="fas fa-crown"></i>
                        <span>روکش</span>
                    </div>
                    <div class="dental-icon-option" data-icon="bridge">
                        <i class="fas fa-grip-lines"></i>
                        <span>بریج</span>
                    </div>
                    <div class="dental-icon-option" data-icon="decay">
                        <i class="fas fa-bug"></i>
                        <span>پوسیدگی</span>
                    </div>
                    <div class="dental-icon-option" data-icon="filling">
                        <i class="fas fa-fill"></i>
                        <span>پر شده</span>
                    </div>
                    <div class="dental-icon-option" data-icon="root-canal">
                        <i class="fas fa-wave-square"></i>
                        <span>عصب کشی شده</span>
                    </div>
                    <div class="dental-icon-option" data-icon="extraction">
                        <i class="fas fa-minus-circle"></i>
                        <span>نیاز به کشیدن</span>
                    </div>
                    <div class="dental-icon-option" data-icon="done">
                        <i class="fas fa-check-circle"></i>
                        <span>درمان تکمیل</span>
                    </div>
                </div>
                <div class="dental-tooth-notes">
                    <label>یادداشت برای این دندان:</label>
                    <textarea class="dental-tooth-note"></textarea>
                </div>
                <div class="dental-modal-actions">
                    <button class="dental-modal-save">ذخیره</button>
                    <button class="dental-modal-cancel">بستن</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/Treatment/treatment.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}
{% block extra_scripts %}
    <script src="{% static 'Treatment/config.js' %}"></script>
    <script src="{% static 'Treatment/api.js' %}"></script>
    <script src="{% static 'Treatment/ui-treatment.js' %}"></script>
    <script src="{% static 'Treatment/main.js' %}"></script>
{% endblock %}

