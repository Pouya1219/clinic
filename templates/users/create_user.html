{% extends 'dashboard.html'%}
{% load static %}
{% block title %}کاربران{% endblock %}
{% block content %}
<section class="main-content">
    <!-- Tab Navigation -->
    <div class="tabs">
        <button class="tab-button active" data-tab="user-info">کاربران</button>
        <button class="tab-button" data-tab="profile-img"> عکس پرفایل </button>
        <button class="tab-button" data-tab="insurance-info">اطلاعات بیمه</button>
        <button class="tab-button" data-tab="salary-info">فیش حقوقی</button>
    </div>

    <!-- Tab Contents -->
   <div class="tab-content active" id="user-info">
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="POST" action="{% url 'create_user' %}" enctype="multipart/form-data">
        {% csrf_token %}
        
        <h1>ساخت کاربر</h1>
        <hr>
        <div class="percentage-card">
            <div class="percentage-grid">
                <div class="percentage-item">
                    <label>نام کاربری</label>
                    <input type="text" name="username" class="form-input">
                </div>
                <div class="percentage-item">
                    <label>رمز عبور</label>
                    <input type="text" name="password" class="form-input">
                </div>
                
                <div class="percentage-item date-inputs">
                    <label>تاریخ اعتبار از</label>
                    <div class="date-input-container input-wrapper input-container">
                        <i class="fas fa-calendar-alt calendar-icon icon-left"></i>
                        <input type="text" name="start_date" class="date-input form-input jalali input-field" value="{{ today_shamsi }}" data-id="6" readonly>
                    </div>
                </div>

                <div class="percentage-item date-inputs">
                    <label>تاریخ اعتبار تا</label>
                    <div class="date-input-container input-wrapper input-container">
                        <i class="fas fa-calendar-alt calendar-icon icon-left"></i>
                        <input type="text" name="end_date" class="date-input form-input jalali input-field" value="{{ next_year_shamsi }}" data-id="7" readonly>
                    </div>
                </div>

                <div class="percentage-item" style="background-color:white; color:black;">
                    <label>تعداد کاربر: {{ total_users }}</label>
                </div>

                {% if remaining_users <= 0 %}
                <div class="alert alert-danger">
                    تعداد کاربران مجاز به پایان رسیده است. لطفا لایسنس خود را ارتقا دهید.
                </div>
                {% else %}
                <div class="alert alert-info">
                    تعداد کاربران باقیمانده: {{ remaining_users }} از {{ license.max_users }}
                </div>
                {% endif %}

                <div class="percentage-item" style="background-color:white; color:black;">
                    <label>کاربر فعال: {{ active_users }}</label>
                </div>

                <div class="percentage-item" style="background-color:white; color:black;">
                    <label class="checkbox-container">
                        <input type="checkbox" name="is_active" checked>
                        <span class="checkmark"></span>
                        کاربر فعال
                    </label>
                </div>
            </div>
        </div>

        <h1>اطلاعات کاربر</h1>
        <hr>
        
        <div class="form-section percentage-card">
            <div class="form-grid">
                <div class="form-group">
                    <label>شماره پرسنلی</label>
                    <input type="text" name="personal_number" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>نام</label>
                    <input type="text" name="first_name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>نام خانوادگی</label>
                    <input type="text" name="last_name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>کد ملی</label>
                    <input type="text" name="national_code" class="form-input" pattern="[0-9]{10}" maxlength="10">
                </div>

                <div class="form-group">
                    <label>موبایل</label>
                    <input type="tel" name="mobile" class="form-input" pattern="[0-9]{11}" maxlength="11">
                </div>
                <div class="form-group">
                    <label>تلفن ثابت</label>
                    <input type="tel" name="phone" class="form-input" pattern="[0-9]{11}" maxlength="11">
                </div>
                <div class="form-group">
                    <label>کد پستی</label>
                    <input type="text" name="postal_code" class="form-input" pattern="[0-9]{10}" maxlength="10">
                </div>

                <div class="form-group">
                    <label>کد نظام پزشکی</label>
                    <input type="text" name="medical_code" class="form-input">
                </div>
                <div class="form-group">
                    <label>سمت</label>
                    <select name="role" class="form-input" required>
                        <option value="">انتخاب کنید</option>
                        {% for role in roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>تخصص پزشک</label>
                    <select name="specialty" class="form-input" id="specialtySelect">
                        <option value="">انتخاب کنید</option>
                        {% for sp in specialties %}
                            <option value="{{ sp.id }}">{{ sp.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>مدرک تحصیلی</label>
                    <select name="education" class="form-input">
                        <option value="">انتخاب کنید</option>
                        {% for ed in educations %}
                            <option value="{{ ed.id }}">{{ ed.degree }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>محل تولد</label>
                    <input type="text" name="birthplace" class="form-input">
                </div>

                <div class="form-group">
                    <label>تاریخ تولد</label>
                    <div class="date-input-container input-wrapper input-container">
                        <i class="fas fa-calendar-alt calendar-icon icon-left"></i>
                        <input type="text" name="birth_date" class="date-input form-input jalali input-field" data-id="110" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label>جنسیت</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="sex" value="true" class="radio-input" checked>
                            <span class="radio-custom"></span>
                            <span class="radio-text">مرد</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="sex" value="false" class="radio-input">
                            <span class="radio-custom"></span>
                            <span class="radio-text">زن</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>وضعیت تاهل</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="is_married" value="false" class="radio-input" checked>
                            <span class="radio-custom"></span>
                            <span class="radio-text">مجرد</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="is_married" value="true" class="radio-input">
                            <span class="radio-custom"></span>
                            <span class="radio-text">متاهل</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>آدرس</label>
                    <textarea name="address" class="form-textarea" rows="4"></textarea>
                </div>
            </div>
        </div>

        <h1>درصد ها</h1>
        <hr>
        <div class="percentage-card">
            <div class="percentage-grid">
                <div class="percentage-item">
                    <h3>درصد کارکرد پزشک</h3>
                    <input type="number" name="work_percentage" class="percentage-input" step="0.01" value="0.00">
                </div>
                <div class="percentage-item">
                    <h3>درصد هزینه لابراتوار</h3>
                    <input type="number" name="lab_expense_percentage" class="percentage-input" step="0.01" value="0.00">
                </div>
                <div class="percentage-item">
                    <h3>درصد هزینه مواد</h3>
                    <input type="number" name="material_expense_percentage" class="percentage-input" step="0.01" value="0.00">
                </div>
                <div class="percentage-item">
                    <h3>درصد مالیات</h3>
                    <input type="number" name="tax_percentage" class="percentage-input" step="0.01" value="0.00">
                </div>
            </div>
        </div>

        <div class="center btn-primary">
            <button type="submit" class="save-button">
                <i class="fas fa-save"></i>
                ذخیره اطلاعات
            </button>
            <a href="{% url 'user_list' %}" class="save-button">
        <i class="fas fa-times"></i>
        انصراف
    </a>
        </div>
    </form>
</div>


        <div class="tab-content percentage-card" id="profile-img">
            <div class="percentage-grid">
                <div class="percentage-grid">
                    <form>
                        <!-- تصاویر -->
                <div class="form-section">
                    <h3>تصاویر</h3>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>تصویر پروفایل</label>
                            <div class="custom-file">
                                <input type="file" name="avatar" class="custom-file-input" id="avatar">
                                <label class="custom-file-label" for="avatar">انتخاب تصویر</label>
                            </div>
                            {% if profile.avatar %}
                            <img src="{{ profile.avatar.url }}" alt="Avatar" class="preview-image mt-2">
                            {% endif %}
                        </div>
                        <div class="form-group col-md-6">
                            <label>امضا</label>
                            <div class="custom-file">
                                <input type="file" name="signature" class="custom-file-input" id="signature">
                                <label class="custom-file-label" for="signature">انتخاب تصویر امضا</label>
                            </div>
                            {% if profile.signature %}
                            <img src="{{ profile.signature.url }}" alt="Signature" class="preview-image mt-2">
                            {% endif %}
                        </div>
                    </div>
                </div>
 <!-- دکمه‌های فرم -->
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">ذخیره تغییرات</button>
                    <a href="{% url 'user_list' %}" class="btn btn-secondary">انصراف</a>
                </div>
                    </form>
                </div>
            </div>   
        </div>

    <!-- Insurance Tab -->
    <div class="tab-content percentage-card" id="insurance-info">
        <div class="insurance-cards percentage-grid">
            <div class="insurance-card percentage-grid">
                <h3>بیمه تامین اجتماعی</h3>
                <div class="form-group">
                    <label>نام کاربری</label>
                    <input type="text" class="form-input">
                </div>
                <div class="form-group">
                    <label>رمز عبور</label>
                    <input type="text" class="form-input">
                </div><br>
                <button class="save-button">ذخیره</button>
            </div>

            <div class="insurance-card percentage-grid">
                <h3>بیمه سلامت</h3>
                <div class="form-group">
                    <label>نام کاربری</label>
                    <input type="text" class="form-input">
                </div>
                <div class="form-group">
                    <label>رمز عبور</label>
                    <input type="text" class="form-input">
                </div><br>
                <button class="save-button">ذخیره</button>
            </div>
        </div>
        <hr>
    </div>
<hr>
     <!-- Salary Tab Content -->
         <!-- Salary Tab -->
          <!-- محتوای فیش حقوقی -->
          <div class="tab-content" id="salary-info">
            <div class="salary-card">
                <div class="salary-grid">
                    <div class="form-group">
                        <label>حقوق پایه</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>حق فرزند</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>حق تاهل</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>پاداش</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>هزینه نهار</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>هزینه صبحانه</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>حق بیمه</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>مالیات</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>اضافه کاری</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>هزینه مرخصی</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>حق ماموریت</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>کسر از حقوق</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>هزینه ایاب و ذهاب</label>
                        <input type="number" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>هزینه بن کالا</label>
                        <input type="number" class="form-input">
                    </div>
                </div>
                <div class="form-group" style="grid-column: 2 / -1;">
                    <label>توضیحات</label>
                    <textarea class="form-textarea" name="address" placeholder="شرح توضیحات..."></textarea>
                </div>
                <hr>
                <div class="percentage-item date-inputs">
                    <label>تاریخ  از </label>
                    
                    <div class="date-input-container input-wrapper input-container">
                        <i class="fas fa-calendar-alt calendar-icon icon-left"></i>
                        <input type="text" class="date-input form-input jalali input-field" data-id="8" readonly placeholder="تاریخ شمسی" readonly>
                    </div>
                    <div class="input-container" style="display:none;">
                        <input type="text" class="date-input gregorian" data-id="8" readonly placeholder="تاریخ میلادی">
                    </div>
                </div>
                <div class="percentage-item date-inputs">
                    <label>تاریخ  تا</label>
                    
                    <div class="date-input-container input-wrapper input-container">
                        <i class="fas fa-calendar-alt calendar-icon icon-left"></i>
                        <input type="text" class="date-input form-input jalali input-field" data-id="9" readonly placeholder="تاریخ شمسی" readonly>
                    </div>
                    <div class="input-container" style="display:none;">
                        <input type="text" class="date-input gregorian" data-id="9" readonly placeholder="تاریخ میلادی">
                    </div>
                </div>
                <hr>
                <div class="center btn-primary">
                    <button type="submit" class="save-button">
                        <i class="fas fa-save"></i>
                        ذخیره اطلاعات
                    </button>
                    
                </div>
                
            </div>
        </div>
            
        </div>
    </div>
</section>
{% block javascript %}
<script>
    $(document).ready(function() {
        // تنظیم تاریخ پیش‌فرض
        const today = new persianDate();
        
        // تنظیمات تقویم
        $('#jalali-date').persianDatepicker({
            initialValue: true,
            format: 'YYYY/MM/DD',
            autoClose: true,
            calendar: {
                persian: {
                    locale: 'fa'
                }
            },
            dayPicker: {
                onSelect: function(unix) {
                    // تبدیل به تاریخ میلادی
                    const gregorianDate = new Date(unix);
                    $('#gregorian-date').val(gregorianDate.toLocaleDateString('en-US'));
                }
            },
            toolbox: {
                enabled: true,
                calendarSwitch: {
                    enabled: false
                }
            },
            navigator: {
                scroll: {
                    enabled: false
                }
            },
            onSelect: function(unix) {
                // بستن تقویم بعد از انتخاب تاریخ
                $(this).persianDatepicker('hide');
            }
        });

        // باز کردن تقویم با کلیک روی آیکون
        $('.calendar-icon').click(function() {
            $('#jalali-date').persianDatepicker('show');
        });
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.datepicker-plot-area').length && 
                !$(e.target).is('#jalali-date') && 
                !$(e.target).is('.calendar-icon')) {
                $('#jalali-date').persianDatepicker('hide');
            }
        });
        // تنظیم تاریخ امروز به صورت پیش‌فرض
        $('#jalali-date').persianDatepicker('setDate', today);
        const gregorianToday = new Date();
        $('#gregorian-date').val(gregorianToday.toLocaleDateString('en-US'));
    });
</script>
<script>
    $(document).ready(function() {
        // تابع تبدیل اعداد به فارسی
        function toPersianNum(num) {
            const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return num.toString().replace(/[0-9]/g, x => persianNumbers[x]);
        }
    
        // تابع اعتبارسنجی و تبدیل تاریخ
        function convertDate(dateStr) {
            // حذف فاصله‌های اضافی
            dateStr = dateStr.trim();
            
            // اگر ورودی خالی است
            if (!dateStr) {
                $('#jalali-result').val('');
                return;
            }
            
            // الگوهای مختلف تاریخ
            const patterns = [
                /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // برای 5/7/2025
                /^(\d{1,2})\/(\d{2})\/(\d{4})$/    // برای 5/07/2025
            ];
    
            let match;
            let isValid = false;
    
            // بررسی الگوها
            for(let pattern of patterns) {
                match = dateStr.match(pattern);
                if(match) {
                    isValid = true;
                    break;
                }
            }
    
            if(!isValid) {
                $('#gregorian-input').addClass('error');
                $('#jalali-result').val('');
                return false;
            }
    
            // برداشتن کلاس error
            $('#gregorian-input').removeClass('error');
    
            try {
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                const year = parseInt(match[3]);
    
                // بررسی معتبر بودن تاریخ
                const date = new Date(year, month - 1, day);
                if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
                    throw new Error('تاریخ نامعتبر است');
                }
    
                // تبدیل به تاریخ شمسی
                const jalaliDate = new persianDate(date);
                
                // فرمت‌بندی خروجی
                const jalaliStr = `${jalaliDate.year()}/${toPersianNum(jalaliDate.month())}/${toPersianNum(jalaliDate.date())}`;
                $('#jalali-result').val(jalaliStr);
                return true;
    
            } catch(e) {
                $('#gregorian-input').addClass('error');
                $('#jalali-result').val('');
                return false;
            }
        }
    
        // متغیر برای ذخیره تایمر
        let convertTimer;
    
        // تبدیل خودکار هنگام تایپ
        $('#gregorian-input').on('input', function() {
            // پاک کردن تایمر قبلی
            clearTimeout(convertTimer);
            
            // تنظیم تایمر جدید
            convertTimer = setTimeout(() => {
                const gregorianDate = $(this).val();
                convertDate(gregorianDate);
            }, 300); // تاخیر 300 میلی‌ثانیه
        });
    
        // پاک کردن کلاس error هنگام تایپ
        $('#gregorian-input').on('focus', function() {
            $(this).removeClass('error');
        });
    
        // حفظ آیکون برای استفاده اختیاری
        $('.convert-icon').click(function() {
            const gregorianDate = $('#gregorian-input').val();
            convertDate(gregorianDate);
        });
    });
    $(document).ready(function() {
        // تنظیم تقویم برای تمام فیلدهای تاریخ شمسی
        $('.date-input.jalali').each(function() {
            let inputField = $(this);
            let targetId = inputField.data('id');
    
            inputField.persianDatepicker({
                initialValue: false,
                format: 'YYYY/MM/DD',
                autoClose: true,
                calendar: {
                    persian: { locale: 'fa' }
                },
                dayPicker: {
                    onSelect: function(unix) {
                        let gregorianDate = new Date(unix);
                        let formattedGregorian = gregorianDate.toLocaleDateString('en-US');
                        
                        // پیدا کردن فیلد میلادی مرتبط با این `data-id`
                        $('.date-input.gregorian[data-id="' + targetId + '"]').val(formattedGregorian);
                    }
                }
            });
        });
    
        // باز کردن تقویم با کلیک روی آیکون
        $('.calendar-icon').click(function() {
            $(this).siblings('.date-input.jalali').persianDatepicker('show');
        });
    
        // بستن تقویم هنگام کلیک خارج از آن
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.datepicker-plot-area').length &&
                !$(e.target).hasClass('jalali') &&
                !$(e.target).hasClass('calendar-icon')) {
                $('.date-input.jalali').persianDatepicker('hide');
            }
        });
    });
    </script>
<!-- در انتهای فایل -->
<script>
document.querySelector('form').addEventListener('submit', function(e) {
    e.preventDefault(); // جلوگیری از ارسال خودکار فرم
    
    // بررسی فیلدهای اجباری
    const requiredFields = ['personal_number', 'first_name', 'last_name'];
    let isValid = true;
    
    requiredFields.forEach(field => {
        const input = this.querySelector(`[name="${field}"]`);
        if (!input.value.trim()) {
            isValid = false;
            input.classList.add('error');
        } else {
            input.classList.remove('error');
        }
    });

    // بررسی مجموع درصدها
    const percentages = [
        'work_percentage',
        'lab_expense_percentage',
        'material_expense_percentage',
        'tax_percentage'
    ].map(name => parseFloat(this.querySelector(`[name="${name}"]`).value) || 0);
    
    const total = percentages.reduce((sum, val) => sum + val, 0);
    
    if (total > 100) {
        alert('مجموع درصدها نمی‌تواند بیشتر از 100 باشد');
        return;
    }

    if (isValid) {
        console.log('Submitting form...');
        this.submit();
    } else {
        alert('لطفاً فیلدهای اجباری را پر کنید');
    }
});
</script>
{% endblock javascript %}
{% endblock content %}
